<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>赵海</title>
    <link rel="stylesheet" href="/assets/css/about-html/table.css" />
    <link rel="stylesheet" href="/assets/css/easyui.css" />
    <link rel="stylesheet" href="/assets/js/libs/layer/skin/layer.css" />
    <script src="/assets/js/libs/jquery-1.8.3.min.js"></script>
    <script src="/assets/js/libs/layer/layer.js"></script>
    <script src="/assets/js/libs/jquery.ztree.core.js"></script>
    <script src="/assets/js/libs/jquery.easyui.min.js"></script>
</head>
<body>
    <div>
        <!--表格-->
        <table class="maketable2" id="makeTable2" style="width: 100%;" cellspacing="0">
            <thead class="thead-box">
            <tr>
                <th style="width:19%;">填写重点工作项目</th>
                <th style="width:45%;">填写达成目标</th>
                <th style="width:9%;">填写权重（%）</th>
                <th style="width:27%;">选择评估人（%）</th>
            </tr>
            </thead>
            <tbody class="tbody-box">
            <tr>
                <td class="">
                    <div contenteditable="true" class="div-textarea div-projct" placeholder="请输入..."></div>
                </td>
                <td class="">
                    <div contenteditable="true" class="div-textarea div-target" placeholder="请输入..."></div>
                </td>
                <td>
                    <input class="input-weight" type="text" placeholder="输入0-100的数" onfocus="this.placeholder=''" onblur="this.placeholder='输入0-100的数'"/>
                </td>
                <td id="ChooseMan">
                    <div class="select-person">
                        <a class="format-chooseman" href="javascript:;">
                            <span>选择人员</span>
                            <i>+</i>
                        </a>
                        <div class="format-percent">%</div>
                        <ul class="selectedlist">
                            <li>
                                <!--<div class="selectedman"><i class="delete-selected"></i></div>
                                <input class="slctpercent" type="text">-->
                            </li>
                        </ul>
                    </div>
                    <!--新增一行-->
                    <div class="add-line jsAddLine">
                        <img src="/assets/img/plus.png" alt="none" />新增一行
                    </div>
                    <!--删除一行-->
                    <div class="delete-line">x</div>
                </td>
            </tr>
            </tbody>
        </table>
        <!--提交按钮-->
        <p class="btn-box">
            <a class="btn jsBtnSubmit">提交</a>
            <a class="btn jsBtnSave">保存草稿</a>
        </p>
    </div>
    <script src="/assets/js/libs/personSelector.js"></script>
    <script src="/assets/js/modules/html/table.js"></script>
    <script>
        $(function () {
            //数据回显
            $('.jsBtnSubmit').click(function(){
                var saveMainObj = {examContentForPortal:{wxamContentVoList:[]}};
                var trindex = $('.tbody-box')[0].rows;
                for (var i=0; i<trindex.length; i++){
                    var row = trindex[i];
                    var workItem = $(row).find('.div-projct').text();
                    var achieveGoal = $(row).find('.div-target').text();
                    var weight = $(row).find('.input-weight').val();
                    var saveItemObj = {achieveGoal:achieveGoal, examScoreVoList:[], weight:weight, workItem:workItem};

                    var itemDom = $('.select-person')[i];
                    var personItem = $(itemDom).find(".selectedlist");
                    personItem.find('li').each(function(i, o){
                        var liObj = $(o);
                        var evaluatorName = liObj.find('.selectedman').text();
                        var evaluatorCode = liObj.attr('evaluatorCode');
                        var itmWeight = liObj.find('.slctpercent').val();
                        var saveItemItemObj = {evaluatorCode:evaluatorCode, evaluatorName:evaluatorName, score:'', scoreRemark:'', weight:itmWeight};
                        saveItemObj.examScoreVoList.push(saveItemItemObj);
                    });
                    saveMainObj.examContentForPortal.wxamContentVoList.push(saveItemObj);
                }
                console.log(JSON.stringify(saveMainObj));
            });
            //数据导入
            $.ajax({
                type : 'get',
                url : "db/table.json",
                dataType : 'json',
                success : function (data) {
                    var tr = '';
                    if(data.length>0){
                        $.each(data,function(index,value){
                            tr += '<tr><td ><div contenteditable="true" class="div-textarea div-projct" placeholder="请输入...">'+value.FiProjct+'</div></td>'
                                    +'<td><div contenteditable="true" class="div-textarea div-target" placeholder="请输入...">'+value.FiTarget+'</div></td>'
                                    +'<td><input class="input-weight" type="text" value="'+value.weight+'" placeholder="输入0-100的数" onfocus=this.placeholder="" onblur=this.placeholder="输入0-100的数" /></td>'
                                    +'<td><div class="select-person"><a class="format-chooseman" href="javascript:;"><span>选择人员</span><i>+</i></a><div class="format-percent">%</div>'
                                    +'<ul class="selectedlist">';
                            if (value.ChooseMan.length>0){
                                $.each(value.ChooseMan,function (val) {
                                    tr += '<li evaluatorCode="'+value.ChooseMan[val].no+'" examScoreId="'+value.ChooseMan[val].id+'"><div class="selectedman">'+value.ChooseMan[val].name+'<i class="delete-selected"></i></div><input class="slctpercent" type="text" value="'+value.ChooseMan[val].weight+'" /></li>';
                                })
                            }
                            tr+= '</ul></div><div class="delete-line">x</div></td></tr>';
                        });
                        $('.tbody-box').append(tr);
                    }
                    $('.add-line').remove();
                    $('.tbody-box td').last().append('<div class="add-line jsAddLine"><img src="/assets/img/plus.png" alt="none" />新增一行</div>');
                    textarea_focus();
                }
            });
        });
        function textarea_focus() {
            $('.div-textarea').focus(function () {
                $(this).parent().addClass('div-textarea-focus');
            });
            $('.div-textarea').blur(function () {
                $(this).parent().removeClass('div-textarea-focus');
            })
        }
    </script>
</body>
</html>